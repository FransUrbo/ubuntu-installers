MEDIA_TYPE = netboot image
TARGET = $(TEMP_INITRD) $(TEMP_KERNEL) all-generic
EXTRANAME = $(MEDIUM)/
INITRD_FS = initramfs

MANIFEST-INITRD = "netboot initrd"
MANIFEST-KERNEL = "kernel image to netboot"

generic:
	mkdir -p $(SOME_DEST)/$(EXTRANAME)/
	cp $(TEMP_KERNEL) $(SOME_DEST)/$(EXTRANAME)/vmlinuz
	cp $(TEMP_INITRD) $(SOME_DEST)/$(EXTRANAME)/initrd.gz
	update-manifest $(SOME_DEST)/$(EXTRANAME)vmlinuz "Linux kernel for generic ARM64"
	update-manifest $(SOME_DEST)/$(EXTRANAME)initrd.gz "initrd for generic ARM64"


xgene:
	# Make sure our build environment is clean
	$(eval INSTALL_PATH=$(SOME_DEST)/netboot/xgene)
	rm -rf $(INSTALL_PATH)
	mkdir -p $(INSTALL_PATH)

	# Generate uImage/uInitrd
	mkimage -A arm -O linux -T kernel -C none -a 0x80000 -e 0x80000 -n "Ubuntu kernel" -d $(TEMP_KERNEL) $(INSTALL_PATH)/uImage
	mkimage -A arm -O linux -T ramdisk -C none -a 0x0 -e 0x0 -n "debian-installer ramdisk" -d $(TEMP_INITRD) $(INSTALL_PATH)/uInitrd

	install -m644 $(TEMP)/tree/lib/firmware/${KERNELVERSION}/device-tree/apm-mustang.dtb $(INSTALL_PATH)

	update-manifest $(INSTALL_PATH)/uImage "Linux kernel for X-Gene Boards"
	update-manifest $(INSTALL_PATH)/uInitrd "initrd for X-Gene Boards"
	update-manifest $(INSTALL_PATH)/apm-mustang.dtb "Device Tree files for APM X-Gene Mustang Boards"

all-generic: generic xgene
