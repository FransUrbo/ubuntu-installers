MEDIA_TYPE = netboot image
SUBARCH = omap
TARGET = $(TEMP_INITRD) $(TEMP_KERNEL) omap
EXTRANAME = $(MEDIUM)
INITRD_FS = initramfs

MANIFEST-INITRD = "netboot initrd"
MANIFEST-KERNEL = "kernel image to netboot"
INSTALL_PATH = $(SOME_DEST)/$(EXTRANAME)

omap:
	# Make sure our build envrionment is clean
	rm -rf $(INSTALL_PATH)
	mkdir -p $(INSTALL_PATH)

	# Generate uImage/uInitrd
	mkimage -A arm -O linux -T kernel -C none -a 0x80008000 -e 0x80008000 -n "Ubuntu kernel" -d $(TEMP_KERNEL) $(INSTALL_PATH)/uImage
	mkimage -A arm -O linux -T ramdisk -C none -a 0x0 -e 0x0 -n "debian-installer ramdisk" -d $(TEMP_INITRD) $(INSTALL_PATH)/uInitrd

	# Generate boot.scrs
	mkimage -A arm -T script -C none -n "Ubuntu boot script (serial)" -d boot/arm/boot.script-omap-serial $(INSTALL_PATH)/boot.scr-serial
	mkimage -A arm -T script -C none -n "Ubuntu boot script (framebuffer)" -d boot/arm/boot.script-omap-fb $(INSTALL_PATH)/boot.scr-fb

	# Create DD'able filesystems
	mkdosfs -C $(INSTALL_PATH)/boot.img-fat-serial 10240
	mcopy -i $(INSTALL_PATH)/boot.img-fat-serial $(INSTALL_PATH)/uImage ::uImage
	mcopy -i $(INSTALL_PATH)/boot.img-fat-serial $(INSTALL_PATH)/uInitrd ::uInitrd
	mcopy -i $(INSTALL_PATH)/boot.img-fat-serial /usr/lib/x-loader/omap3530beagle/MLO ::MLO
	mcopy -i $(INSTALL_PATH)/boot.img-fat-serial /usr/lib/u-boot/omap3_beagle/u-boot.bin ::u-boot.bin
	cp $(INSTALL_PATH)/boot.img-fat-serial $(INSTALL_PATH)/boot.img-fat-fb
	mcopy -i $(INSTALL_PATH)/boot.img-fat-serial $(INSTALL_PATH)/boot.scr-serial ::boot.scr
	mcopy -i $(INSTALL_PATH)/boot.img-fat-fb $(INSTALL_PATH)/boot.scr-fb ::boot.scr
	boot/arm/generate-partitioned-filesystem $(INSTALL_PATH)/boot.img-fat-fb $(INSTALL_PATH)/boot.img-fb
	boot/arm/generate-partitioned-filesystem $(INSTALL_PATH)/boot.img-fat-serial $(INSTALL_PATH)/boot.img-serial

	# Publish SPL
	cp /usr/lib/x-loader/omap3530beagle/MLO $(INSTALL_PATH)/MLO
	cp /usr/lib/u-boot/omap3_beagle/u-boot.bin $(INSTALL_PATH)/u-boot.bin

	# Generate manifests
	update-manifest $(INSTALL_PATH)/uImage "Linux kernel for OMAP Boards"
	update-manifest $(INSTALL_PATH)/uInitrd "initrd for OMAP Boards"
	update-manifest $(INSTALL_PATH)/boot.scr-fb "Boot script for booting OMAP netinstall initrd and kernel from SD card. Uses framebuffer display"
	update-manifest $(INSTALL_PATH)/boot.scr-serial "Boot script for booting OMAP netinstall initrd and kernel from SD card. Uses serial output"
	update-manifest $(INSTALL_PATH)/boot.img-serial "Boot image for booting OMAP netinstall. Uses serial output"
	update-manifest $(INSTALL_PATH)/boot.img-fb "Boot image for booting OMAP netinstall. Uses framebuffer output"
	update-manifest $(INSTALL_PATH)/MLO "MMC Loader for OMAP3 Beagleboards"
	update-manifest $(INSTALL_PATH)/u-boot.bin "Universal Bootloader for OMAP3 Beagleboards"
